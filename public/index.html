<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Texture Makers Server</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/img/icon.png" type="image/x-icon">
    <meta name="description" content="A collection of texture packs made by the Texture Makers community.">
    <meta name="keywords" content="Texture Packs, Texture Makers, Download, Server">
    <meta name="google-site-verification" content="QCSYz2rA9wSjZDzi3caaGW4P8qr9OyDlcqAacH2eC_0" />
    <meta property="og:title" content="Texture Makers Server">
    <meta property="og:description" content="A collection of texture packs made by the Texture Makers community.">
    <meta property="og:image" content="https://texture-server.onrender.com/img/thumbnail.png">
    <meta property="og:url" content="https://texture-server.onrender.comg">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://texture-server.onrender.com/img/thumbnail.png">
</head>
<body>
    <img src="/img/title.png" alt="title" class="title">

    <div class="top-bar">
        <input type="search" id="search" placeholder="Search Texture Pack...">
        <button id="searchBtn">Search</button>
        <select id="filterResolution">
            <option selected disabled>Resolutions</option>
            <option value="all" selected>All</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
        </select>
        <select id="filter">
            <option selected disabled>Filter</option>
            <option value="most-recent" selected>Most Recent</option>
            <option value="most-downloaded">Most Dowloaded</option>
        </select>
        <button id="addPackBtn" class="add-pack-btn">Add my texture pack</button>
    </div>

    <div id="cards-container"></div>
    <div id="pagination"></div>

    <div id="popup" class="popup-bg">
        <div class="popup-box"></div>
    </div>

    <div id="invite-popup" class="popup-bg" aria-hidden="true">
        <div class="popup-box invite-box">
            <div class="popup-top">
                <img src="/img/icon.png" alt="icon" class="pack-icon">
                <div class="popup-info">
                    <h2>Join our Discord</h2>
                    <p>Want to add your texture pack? Join our Discord server to submit and get help from the community.</p>
                    <p><a id="discordInviteLink" href="https://discord.gg/YMGPn26WMN" target="_blank" rel="noopener">Join the Discord</a></p>
                    <button class="close-invite-btn">Close</button>
                </div>
            </div>
        </div>
    </div>

        <script>
            let currentPage = 1;
            const cardsPerPage = 6;
            let texturePacks = [];
        
            // --- Seletores ---
            const cardsContainer = document.getElementById("cards-container");
            const searchInput = document.getElementById("search");
            const searchBtn = document.getElementById("searchBtn");
            const filterResolutionSelect = document.getElementById("filterResolution"); 
            const popup = document.getElementById("popup");
            const popupBox = popup.querySelector(".popup-box");
            const addPackBtn = document.getElementById("addPackBtn");
            const invitePopup = document.getElementById("invite-popup");
            const inviteCloseBtn = invitePopup.querySelector('.close-invite-btn');
            const discordInviteLink = document.getElementById('discordInviteLink');
            const filterSortSelect = document.getElementById("filter"); 
        
            const DISCORD_INVITE = 'https://discord.gg/YMGPn26WMN';

            // --- Funções de API ---
        
            async function fetchPacks() {
                try {
                    const res = await fetch("/api/packs");
                    const contentType = res.headers.get('content-type') || '';
                
                    if (!res.ok) {
                        const text = await res.text();
                        console.error('Failed to fetch packs:', res.status, text);
                        return;
                    }
                
                    if (contentType.includes('application/json')) {
                        texturePacks = await res.json();
                    } else {
                        const text = await res.text();
                        console.error('Expected JSON from /api/packs but received:', text);
                        return;
                    }
                
                    filterSearch(); // Aplica a ordenação padrão (Recente) e renderiza.
                } catch (err) {
                    console.error('Error fetching packs:', err);
                }
            }
        
            fetchPacks();
        
            async function trackDownload(packId, downloadUrl, countEl) {
                try {
                    const res = await fetch(`/api/download/${packId}`, { method: 'POST' });
                    const contentType = res.headers.get('content-type') || '';
                
                    if (!res.ok) {
                        const text = await res.text();
                        console.error('Download tracking failed:', res.status, text);
                    } else if (contentType.includes('application/json')) {
                        const data = await res.json();
                        if (data.success && countEl) {
                            // Atualiza a contagem no Card ou Pop-up que foi passado
                            countEl.textContent = `${data.downloads}`;

                            // Opcional: Se você usa "Mais Baixados", re-renderize para mudar a ordem
                            // if (filterSortSelect.value === 'most-downloaded') {
                            //     fetchPacks(); // Re-fetch e re-renderiza toda a lista
                            // }
                        }
                    } else {
                        const text = await res.text();
                        console.error('Unexpected response for download tracking:', text);
                    }
                } catch (err) {
                    console.error('Download tracking failed:', err);
                }
            
                // Inicia o download do arquivo após (ou durante) o rastreamento
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = '';
                link.click();
            }
        
            // --- Funções de Renderização e Lógica ---
        
            function renderCards(list) {
                cardsContainer.innerHTML = "";
            
                const totalPagesAfterFilter = Math.ceil(list.length / cardsPerPage);

                // Ajusta a página atual se necessário
                if (currentPage > totalPagesAfterFilter && totalPagesAfterFilter > 0) {
                    currentPage = totalPagesAfterFilter;
                } else if (list.length === 0) {
                    currentPage = 1;
                    cardsContainer.innerHTML = "<p>Nenhum pacote encontrado com os critérios de busca/filtro.</p>";
                    renderPagination(list);
                    return;
                }
            
                const start = (currentPage - 1) * cardsPerPage;
                const end = start + cardsPerPage;
                const pageItems = list.slice(start, end);
            
                if (pageItems.length === 0 && list.length > 0) {
                    // Se cair em uma página vazia por algum erro de cálculo
                    currentPage = 1; 
                    renderCards(list); 
                    return;
                }
            
            
                pageItems.forEach(pack => {
                    const card = document.createElement("div");
                    card.classList.add("card");

                    // Atributo de dados para facilitar a busca de elementos no pop-up (se necessário)
                    card.dataset.id = pack.id; 
                
                    card.innerHTML = `
                        <div class="card-top">
                            <img src="${pack.icon}" alt="Icon" class="card-icon">
                            <div class="card-content">
                                <h3>${pack.name} by ${pack.creator} - ${pack.version}</h3>
                                <p>${pack.description}</p>
                                <button class="download-btn" data-id="${pack.id}" data-url="${pack.download}">Download (${pack.version})</button>
                                <p class="download-count"><small>${pack.downloads || 0} downloads</small></p>
                                <button class="more-info">i</button>
                            </div>
                        </div>
                        <img src="${pack.screenshot}" alt="screenshot" class="card-screenshot">
                    `;
                    
                    cardsContainer.appendChild(card);
                    
                    // Adiciona Listener para o botão de DOWNLOAD do CARD
                    const dlBtn = card.querySelector(".download-btn");
                    const countEl = card.querySelector(".download-count small");
                    dlBtn.addEventListener("click", () => trackDownload(pack.id, pack.download, countEl));
                    
                    // Adiciona Listener para o botão de MAIS INFORMAÇÕES
                    card.querySelector(".more-info").addEventListener("click", () => openPopup(pack));
                });
            
                renderPagination(list);
            }
        
            function renderPagination(list) {
                // ... (Sua função renderPagination está correta e não precisa de alterações)
                const pagination = document.getElementById("pagination");
                pagination.innerHTML = "";
            
                const totalPages = Math.ceil(list.length / cardsPerPage);
                if (totalPages <= 1) return;
            
                const prev = document.createElement("button");
                prev.textContent = "Prev";
                prev.disabled = currentPage === 1;
                prev.onclick = () => { currentPage--; renderCards(list); }; 
                pagination.appendChild(prev);
            
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement("button");
                    btn.textContent = i;
                    if (i === currentPage) btn.classList.add("active-page");
                    btn.onclick = () => { currentPage = i; renderCards(list); };
                    pagination.appendChild(btn);
                }
            
                const next = document.createElement("button");
                next.textContent = "Next";
                next.disabled = currentPage === totalPages;
                next.onclick = () => { currentPage++; renderCards(list); };
                pagination.appendChild(next);
            }
        
            function sortPacks(list, sortBy) {
                if (sortBy === "most-downloaded") {
                    return [...list].sort((a, b) => (b.downloads || 0) - (a.downloads || 0));
                }
                // Assume que a ordem padrão (fetchPacks) é a "Most Recent"
                return list; 
            }
        
            function filterSearch() {
                const text = searchInput.value.toLowerCase();
                const resolution = filterResolutionSelect.value;
                const sortOption = filterSortSelect.value;
            
                // 1. Filtragem (Busca por texto + Resolução)
                let filtered = texturePacks.filter(pack => 
                    pack.name.toLowerCase().includes(text) &&
                    (resolution === "all" || pack.resolution.toLowerCase().includes(resolution))
                );
            
                // 2. Ordenação
                const sortedAndFiltered = sortPacks(filtered, sortOption);
            
                // 3. Renderização
                // Resetamos para a primeira página após qualquer mudança de filtro/busca/ordenação
                currentPage = 1; 
                renderCards(sortedAndFiltered);
            }
        
            // --- Funções de Pop-up ---
        
            function openPopup(pack) {
                // Define o ID no box principal (útil para CSS ou debug)
                popupBox.dataset.id = pack.id;

                // Define o HTML do Pop-up
                popupBox.innerHTML = `
                    <div class="popup-top">
                        <img src="${pack.icon}" alt="Icone do Pack" class="pack-icon"> 
                    
                        <div class="popup-info">
                            <h2 class="title-popp">${pack.name} - ${pack.version}</h2>
                        
                            <div class="info-details-list">
                                <p><strong>Criador:</strong> ${pack.creator}</p>
                                <p><strong>Versão:</strong> ${pack.version}</p>
                                <p><strong>Resolução:</strong> ${pack.resolution}</p>
                                <p class="cont-download"><strong>Downloads:</strong> <span id="popup-download-count">${pack.downloads || 0}</span></p>
                            
                                <p style="font-size: 12px; color: #777;">ID: ${pack.id}</p>
                            </div>
                        
                            <button 
                                id="popupDownloadBtn" 
                                class="download-btn"
                                data-id="${pack.id}" 
                                data-url="${pack.download}">
                                Download (${pack.version})
                            </button>
                        
                        </div>
                    </div>
                
                    <div class="popup-bottom-content">
                    
                        <p class="description-block">${pack.description || "Descrição não fornecida."}</p>
                    
                        <div class="action-links">
                            <button 
                                class="details-btn" 
                                onclick="window.open('pack-detail.html?id=${pack.id}', '_blank')">
                                View The Post of ${pack.name} &rarr;
                            </button>
                        </div>
                    </div>
                
                    <img src="${pack.screenshot}" alt="Screenshot" class="popup-image">
                
                    <button id="closePopup" class="closepopup">Close</button>`;
                
                // CORREÇÃO CRÍTICA: Anexar o listener ao botão DENTRO do POP-UP recém-criado
                const popupDlBtn = popupBox.querySelector("#popupDownloadBtn");
                const popupCountEl = popupBox.querySelector("#popup-download-count"); // Novo ID para o span da contagem
                
                if (popupDlBtn && popupCountEl) {
                    popupDlBtn.addEventListener("click", () => trackDownload(pack.id, pack.download, popupCountEl));
                }
            
                // Exibir o Pop-up
                popup.style.display = "flex";
                document.body.classList.add("no-scroll");

                // Anexar listener de Fechar Pop-up
                const closeBtn = document.getElementById("closePopup");
                closeBtn.addEventListener("click", () => {
                    popup.style.display = "none";
                    document.body.classList.remove("no-scroll");
                });
            
                // Listener para fechar clicando fora do box
                popup.addEventListener("click", e => {
                    if (e.target === popup) {
                        popup.style.display = "none";
                        document.body.classList.remove("no-scroll");
                    }
                });
            }
        
            // --- Listeners de Eventos Globais ---
        
            searchBtn.addEventListener("click", filterSearch);
            searchInput.addEventListener("input", filterSearch); 
            searchInput.addEventListener("keypress", (e) => { if(e.key === "Enter") filterSearch(); });
        
            filterResolutionSelect.addEventListener("change", filterSearch);
            filterSortSelect.addEventListener("change", filterSearch);
        
            if (addPackBtn) {
                addPackBtn.addEventListener('click', () => {
                    discordInviteLink.href = DISCORD_INVITE;
                    invitePopup.style.display = 'flex';
                    document.body.classList.add('no-scroll');
                });
            }
        
            if (inviteCloseBtn) {
                inviteCloseBtn.addEventListener('click', () => {
                    invitePopup.style.display = 'none';
                    document.body.classList.remove('no-scroll');
                });
            }
        
            invitePopup.addEventListener('click', e => {
                if (e.target === invitePopup) {
                    invitePopup.style.display = 'none';
                    document.body.classList.remove('no-scroll');
                }
            });
        </script>

    <footer class="site-footer" role="contentinfo">
        <div class="footer-inner">
            <a class="social-btn youtube" href="https://www.youtube.com/@ChessDash543" target="_blank" rel="noopener" aria-label="YouTube">
                <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false"><path fill="#FF0000" d="M23.5 6.2a3.0 3.0 0 0 0-2.1-2.1C19.6 3.5 12 3.5 12 3.5s-7.6 0-9.4.6A3.0 3.0 0 0 0 .5 6.2 29.3 29.3 0 0 0 0 12a29.3 29.3 0 0 0 .5 5.8 3.0 3.0 0 0 0 2.1 2.1c1.8.6 9.4.6 9.4.6s7.6 0 9.4-.6a3.0 3.0 0 0 0 2.1-2.1A29.3 29.3 0 0 0 24 12a29.3 29.3 0 0 0-.5-5.8z"></path><path fill="#fff" d="M9.8 15.5V8.5l6.2 3.5-6.2 3.5z"></path></svg>
                <span class="social-label">YouTube</span>
            </a>

            <a class="social-btn discord" href="https://discord.gg/YMGPn26WMN" target="_blank" rel="noopener" aria-label="Discord">
                <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false"><path fill="#7289DA" d="M20.317 4.369a19.791 19.791 0 0 0-4.885-1.515.07.07 0 0 0-.075.037c-.211.375-.445.864-.608 1.249-1.84-.276-3.68-.276-5.486 0-.163-.39-.405-.88-.617-1.255a.07.07 0 0 0-.076-.036A19.736 19.736 0 0 0 3.678 4.37a.064.064 0 0 0-.03.024C.533 9.045-.319 13.46.066 17.8a.082.082 0 0 0 .031.056 19.9 19.9 0 0 0 6.058 3.08.07.07 0 0 0 .078-.027c.468-.637.885-1.31 1.24-2.01a.07.07 0 0 0-.038-.099 13.35 13.35 0 0 1-1.9-.9.07.07 0 0 1-.007-.12c.127-.096.254-.197.375-.305a.07.07 0 0 1 .073-.01c3.97 1.79 8.27 1.79 12.11 0a.07.07 0 0 1 .076.01c.12.108.247.209.374.305a.07.07 0 0 1-.006.12c-.646.4-1.317.754-1.9.899a.07.07 0 0 0-.038.1c.36.7.777 1.374 1.245 2.01a.07.07 0 0 0 .078.026 19.907 19.907 0 0 0 6.058-3.08.082.082 0 0 0 .031-.056c.5-7.168-2.9-11.561-3.93-12.467a.062.062 0 0 0-.03-.023z"></path><path fill="#fff" d="M8.02 13.577c-1.18 0-2.14-1.085-2.14-2.423 0-1.337.955-2.423 2.14-2.423 1.2 0 2.164 1.086 2.14 2.423 0 1.338-.955 2.423-2.14 2.423zm7.96 0c-1.18 0-2.14-1.085-2.14-2.423 0-1.337.955-2.423 2.14-2.423 1.2 0 2.165 1.086 2.14 2.423 0 1.338-.94 2.423-2.14 2.423z"></path></svg>
                <span class="social-label">Discord</span>
            </a>

            <a class="social-btn github" href="https://github.com/Chessdash543/texture-server" target="_blank" rel="noopener" aria-label="GitHub">
                <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false"><path fill="#fff" d="M12 .5C5.73.5.5 5.74.5 12.02c0 5.1 3.29 9.42 7.86 10.95.58.11.79-.25.79-.56 0-.28-.01-1.02-.02-2-3.2.7-3.88-1.54-3.88-1.54-.52-1.33-1.27-1.69-1.27-1.69-1.04-.71.08-.7.08-.7 1.16.08 1.77 1.2 1.77 1.2 1.02 1.75 2.68 1.24 3.33.95.1-.74.4-1.24.73-1.53-2.55-.29-5.23-1.28-5.23-5.69 0-1.26.45-2.29 1.2-3.1-.12-.3-.52-1.51.11-3.15 0 0 .98-.31 3.2 1.18a11.05 11.05 0 0 1 2.92-.39c.99 0 1.99.13 2.92.39 2.22-1.49 3.2-1.18 3.2-1.18.63 1.64.23 2.85.11 3.15.75.81 1.2 1.84 1.2 3.1 0 4.42-2.69 5.39-5.25 5.67.41.36.77 1.07.77 2.15 0 1.55-.01 2.8-.01 3.18 0 .31.21.68.8.56A10.52 10.52 0 0 0 23.5 12c0-6.28-5.23-11.5-11.5-11.5z"/></svg>
                <span class="social-label">GitHub</span>
            </a>
            <a class="social-btn admin" href="/admin.html" title="Admin" aria-label="Admin">
                <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
                    <path fill="#64B5F6" d="M12 2a5 5 0 00-5 5v4H6a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2v-9a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm3 9H9V7a3 3 0 016 0v4z"/>
                </svg>

                <span class="social-label">Admin</span>
            </a>
        </div>
    </footer>
</body>
</html>
